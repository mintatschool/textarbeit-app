import React, { useState, useRef, useEffect } from 'react';
import { Icons } from './Icons';

export const SettingsModal = ({ settings, setSettings, onExport, onImport, logo, setLogo, onClose, onClearHighlights, onPrint, onShowQR }) => {
    const fileInputRef = useRef(null);
    const [printType, setPrintType] = useState('text');
    useEffect(() => { const handleEsc = (e) => { if (e.key === 'Escape') onClose(); }; window.addEventListener('keydown', handleEsc); return () => window.removeEventListener('keydown', handleEsc); }, [onClose]);
    const handleFileChange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setLogo(reader.result); reader.readAsDataURL(file); } };
    const handleImportClick = () => { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => onImport(ev.target.result); reader.readAsText(file); } }; input.click(); };

    return (
        <div className="fixed inset-0 z-[120] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 font-sans">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 modal-animate overflow-y-auto max-h-[90vh] custom-scroll">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icons.Settings className="text-gray-600" /> Einstellungen</h2>
                    <button onClick={onClose} className="p-3 hover:bg-slate-100 rounded-full min-touch-target"><Icons.X /></button>
                </div>
                <div className="space-y-6">
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">Logo / Bild</label>
                        <div className="flex items-center gap-4">
                            <div className="w-16 h-16 border rounded-lg bg-slate-50 flex items-center justify-center overflow-hidden">{logo ? <img src={logo} alt="Logo" className="w-full h-full object-contain" /> : <Icons.Image className="text-slate-300" />}</div>
                            <button onClick={() => fileInputRef.current.click()} className="px-4 py-3 border border-slate-300 rounded-lg text-sm hover:bg-slate-50 transition min-touch-target">Bild wählen...</button>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                            {logo && <button onClick={() => setLogo(null)} className="text-red-500 text-sm hover:underline min-touch-target">Löschen</button>}
                        </div>
                    </div>
                    <hr className="border-slate-100" />
                    <div><h3 className="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><span className="bg-slate-200 text-slate-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">1</span> Silbenanzeige</h3>
                        <div className="flex bg-slate-100 rounded-lg p-1 mb-2"><button onClick={() => setSettings({ ...settings, visualType: 'block' })} className={`flex-1 py-3 px-2 rounded-md text-sm font-bold transition-all min-touch-target ${settings.visualType === 'block' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Boxen</button><button onClick={() => setSettings({ ...settings, visualType: 'arc' })} className={`flex-1 py-3 px-2 rounded-md text-sm font-bold transition-all min-touch-target ${settings.visualType === 'arc' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Bögen</button><button onClick={() => setSettings({ ...settings, visualType: 'black_gray' })} className={`flex-1 py-3 px-2 rounded-md text-sm font-bold transition-all min-touch-target ${settings.visualType === 'black_gray' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>schwarz/grau</button></div>
                        <div className="flex bg-slate-100 rounded-lg p-1"><button onClick={() => setSettings({ ...settings, displayTrigger: 'always' })} className={`flex-1 py-3 px-2 rounded-md text-sm font-bold transition-all min-touch-target ${settings.displayTrigger === 'always' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Alle Wörter</button><button onClick={() => setSettings({ ...settings, displayTrigger: 'click' })} className={`flex-1 py-3 px-2 rounded-md text-sm font-bold transition-all min-touch-target ${settings.displayTrigger === 'click' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>Markierte Wörter</button></div>
                    </div>
                    <hr className="border-slate-100" />
                    <div><h3 className="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><span className="bg-slate-200 text-slate-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">2</span> Aktionen</h3>
                        <div className="flex items-center justify-between mb-4 bg-slate-50 p-2 rounded border border-slate-100"><div className="text-sm font-bold text-slate-700">Intelligente Auswahl (sch, ch, ck...)</div><button onClick={() => setSettings({ ...settings, smartSelection: !settings.smartSelection })} className={`w-12 h-6 rounded-full p-1 transition-colors min-touch-target ${settings.smartSelection ? 'bg-green-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${settings.smartSelection ? 'translate-x-6' : 'translate-x-0'}`}></div></button></div>
                        <div className="flex flex-col gap-2"><button onClick={() => setSettings({ ...settings, clickAction: 'yellow_border' })} className={`flex items-center gap-3 px-3 py-3 rounded-lg border text-left transition-all min-touch-target ${settings.clickAction === 'yellow_border' ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'bg-white border-slate-200 hover:border-slate-300'}`}><div className={`w-4 h-4 rounded-full border flex items-center justify-center shrink-0 ${settings.clickAction === 'yellow_border' ? 'border-blue-600' : 'border-slate-300'}`}>{settings.clickAction === 'yellow_border' && <div className="w-2 h-2 bg-blue-600 rounded-full"></div>}</div><div><div className="font-bold text-slate-800 text-sm">Gelb markiert</div><div className="text-xs text-slate-500">Umrandung</div></div></button><button onClick={() => setSettings({ ...settings, clickAction: 'dark_blue' })} className={`flex items-center gap-3 px-3 py-3 rounded-lg border text-left transition-all min-touch-target ${settings.clickAction === 'dark_blue' ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'bg-white border-slate-200 hover:border-slate-300'}`}><div className={`w-4 h-4 rounded-full border flex items-center justify-center shrink-0 ${settings.clickAction === 'dark_blue' ? 'border-blue-600' : 'border-slate-300'}`}>{settings.clickAction === 'dark_blue' && <div className="w-2 h-2 bg-blue-600 rounded-full"></div>}</div><div><div className="font-bold text-slate-800 text-sm">Hervorgehoben</div><div className="text-xs text-slate-500">Dunkelblau & Fett</div></div></button><button onClick={() => { setSettings({ ...settings, clickAction: 'none' }); onClearHighlights(); }} className={`flex items-center gap-3 px-3 py-3 rounded-lg border text-left transition-all min-touch-target ${settings.clickAction === 'none' ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'bg-white border-slate-200 hover:border-slate-300'}`}><div className={`w-4 h-4 rounded-full border flex items-center justify-center shrink-0 ${settings.clickAction === 'none' ? 'border-blue-600' : 'border-slate-300'}`}>{settings.clickAction === 'none' && <div className="w-2 h-2 bg-blue-600 rounded-full"></div>}</div><div><div className="font-bold text-slate-800 text-sm">Nur Silbengliederung</div><div className="text-xs text-slate-500">Keine Markierung, Klick toggelt Wort</div></div></button><button onClick={() => { setSettings({ ...settings, clickAction: 'light_blue' }); onClearHighlights(); }} className={`flex items-center gap-3 px-3 py-3 rounded-lg border text-left transition-all min-touch-target ${settings.clickAction === 'light_blue' ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'bg-white border-slate-200 hover:border-slate-300'}`}><div className={`w-4 h-4 rounded-full border flex items-center justify-center shrink-0 ${settings.clickAction === 'light_blue' ? 'border-blue-600' : 'border-slate-300'}`}>{settings.clickAction === 'light_blue' && <div className="w-2 h-2 bg-blue-600 rounded-full"></div>}</div><div><div className="font-bold text-slate-800 text-sm">Einfarbig</div><div className="text-xs text-slate-500">Blau hinterlegt, ganzes Wort</div></div></button></div>
                    </div>
                    <hr className="border-slate-100" />
                    <div><h3 className="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><span className="bg-slate-200 text-slate-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">3</span> Ansicht</h3>
                        <div className="flex items-center justify-between mb-2"><label className="text-sm font-bold text-slate-700">Geklickte Wörter vergrößern</label><button onClick={() => setSettings({ ...settings, zoomActive: !settings.zoomActive })} className={`w-12 h-6 rounded-full p-1 transition-colors min-touch-target ${settings.zoomActive ? 'bg-green-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${settings.zoomActive ? 'translate-x-6' : 'translate-x-0'}`}></div></button></div>
                        <div className="flex items-center justify-between mb-4"><label className="text-sm font-bold text-slate-700">Scrollen im Lesemodus verhindern</label><button onClick={() => setSettings({ ...settings, lockScroll: !settings.lockScroll })} className={`w-12 h-6 rounded-full p-1 transition-colors min-touch-target ${settings.lockScroll ? 'bg-green-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${settings.lockScroll ? 'translate-x-6' : 'translate-x-0'}`}></div></button></div>
                        <div className="grid grid-cols-2 gap-6"><div className="col-span-2"><label className="block text-sm font-bold text-slate-700 mb-2">Textbreite</label><input type="range" min="50" max="100" step="1" value={settings.textWidth} onChange={(e) => setSettings({ ...settings, textWidth: parseInt(e.target.value) })} className="w-full accent-blue-600 h-2 bg-slate-200 rounded-lg cursor-pointer" /></div><div><label className="block text-sm font-bold text-slate-700 mb-2">Zeilenabstand</label><input type="range" min="1.5" max="4.0" step="0.1" value={settings.lineHeight} onChange={(e) => setSettings({ ...settings, lineHeight: parseFloat(e.target.value) })} className="w-full accent-blue-600 h-2 bg-slate-200 rounded-lg cursor-pointer" /></div><div><label className="block text-sm font-bold text-slate-700 mb-2">Wortabstand</label><input type="range" min="0" max="2" step="0.1" value={settings.wordSpacing || 0} onChange={(e) => setSettings({ ...settings, wordSpacing: parseFloat(e.target.value) })} className="w-full accent-blue-600 h-2 bg-slate-200 rounded-lg cursor-pointer" /></div></div>
                    </div>
                    <hr className="border-slate-100" />
                    <div><h3 className="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2"><span className="bg-slate-200 text-slate-600 rounded-full w-6 h-6 flex items-center justify-center text-sm">4</span> Schriftart</h3>
                        <div className="space-y-2">{[{ name: "Patrick Hand", val: "'Patrick Hand', cursive" }, { name: "Comic Sans", val: "'Comic Sans MS', cursive" }, { name: "Mali", val: "'Mali', cursive" }, { name: "Andika", val: "'Andika', sans-serif" }, { name: "Open Sans", val: "'Open Sans', sans-serif" }].map((font, idx) => (<button key={idx} onClick={() => setSettings({ ...settings, fontFamily: font.val })} className={`w-full text-left px-4 py-3 rounded-lg border flex items-center justify-between transition min-touch-target ${settings.fontFamily === font.val ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200 hover:border-slate-300'}`}><span style={{ fontFamily: font.val }} className="text-lg">{font.name}</span>{settings.fontFamily === font.val && <Icons.Check className="text-blue-600" />}</button>))}</div>
                    </div>
                    <hr className="border-slate-100" />
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">Teilen</label>
                        <button onClick={onShowQR} className="w-full py-3 mb-4 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm min-touch-target"><Icons.QrCode size={20} /> Link / QR-Code teilen</button>

                        <label className="block text-sm font-bold text-slate-700 mb-2">Import / Export (Datei)</label>
                        <div className="flex gap-4 mb-4">
                            <button onClick={onExport} className="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 font-medium flex items-center justify-center gap-2 min-touch-target"><Icons.Download size={18} /> Speichern</button>
                            <button onClick={handleImportClick} className="flex-1 py-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-700 font-medium flex items-center justify-center gap-2 min-touch-target"><Icons.Upload size={18} /> Laden</button>
                        </div>
                        <label className="block text-sm font-bold text-slate-700 mb-2">Drucken</label>
                        <div className="flex gap-2">
                            <select value={printType} onChange={(e) => setPrintType(e.target.value)} className="flex-1 bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none font-medium min-touch-target"><option value="text">Text (Standard)</option><option value="list">Liste / Tabelle</option><option value="carpet">Silbenteppich</option></select>
                            <button onClick={() => onPrint(printType)} className="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 flex items-center justify-center transition shadow-sm min-touch-target"><Icons.Printer size={20} /></button>
                        </div>
                    </div>

                    <hr className="border-slate-100" />
                    <div className="flex items-center justify-between opacity-50 hover:opacity-100 transition-opacity">
                        <label className="text-xs text-slate-500 font-medium cursor-pointer" onClick={() => setSettings({ ...settings, enableCamera: !settings.enableCamera })}>Foto-Import Funktion anzeigen</label>
                        <button onClick={() => setSettings({ ...settings, enableCamera: !settings.enableCamera })} className={`w-8 h-4 rounded-full p-0.5 transition-colors min-touch-target ${settings.enableCamera ? 'bg-slate-500' : 'bg-slate-300'}`}>
                            <div className={`w-3 h-3 bg-white rounded-full shadow-md transform transition-transform ${settings.enableCamera ? 'translate-x-4' : 'translate-x-0'}`}></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};
